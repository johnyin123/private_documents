cat > /etc/X11/xorg.conf.d/20-sky.conf <<'EOF'
Section "InputClass"
    Identifier "SKYWORTH_0120 BLE REMOTE"
    MatchProduct "SKYWORTH_0120"
    Option "Ignore" "true"
EndSection
EOF
cat > /etc/triggerhappy/triggers.d/sky.conf <<'EOF'
KEY_LEFT         1   /usr/bin/remoter.sh johnyin smplayer rewind1
KEY_RIGHT        1   /usr/bin/remoter.sh johnyin smplayer forward1
KEY_LEFT         2   /usr/bin/remoter.sh johnyin smplayer rewind2
KEY_RIGHT        2   /usr/bin/remoter.sh johnyin smplayer forward2
KEY_UP           1   /usr/bin/remoter.sh johnyin smplayer increase_volume
KEY_DOWN         1   /usr/bin/remoter.sh johnyin smplayer decrease_volume
KEY_SELECT       1   /usr/bin/remoter.sh johnyin smplayer play_or_pause
KEY_COMPOSE      1   /usr/bin/remoter.sh johnyin smplayer show_playlist
KEY_POWER        1   /usr/bin/remoter.sh johnyin start_stop
KEY_F5           1   /usr/bin/remoter.sh johnyin xsendkey Return
KEY_ESC          1   /usr/bin/remoter.sh johnyin xsendkey Tab
KEY_VOLUMEUP     1   /usr/bin/remoter.sh johnyin xsendkey Up
KEY_VOLUMEDOWN   1   /usr/bin/remoter.sh johnyin xsendkey Down
EOF
cat > /usr/bin/remoter.sh <<'EOF'
#!/bin/sh
MEDIA_DIR=/media
LIST_FILE=/tmp/list.m3u8
if [ -f /etc/skyworth_120.conf ]; then
  . /etc/skyworth_120.conf
fi
smplayer_start_stop() {
    local user=$1
    shift 1
    logger -t triggerhappy "smplayer start/stop"
    pgrep -u ${user} smplayer && {
        systemd-run --uid=${user} -E DISPLAY=:0 smplayer -send-action close
        pkill -u ${user} smplayer
    } || {
        find ${MEDIA_DIR} -type f -iname '*.mkv' \
            -o -iname '*.avi' \
            -o -iname '*.mp4' \
            -o -iname '*.wmv' > ${LIST_FILE}
        chown ${user} ${LIST_FILE}
        systemd-run --uid=${user} -E DISPLAY=:0 smplayer -actions 'stop fullscreen' ${LIST_FILE}
    }
}
smplayer_action() {
    local user=$1
    shift 1
    logger -t triggerhappy "send-action start($*)"
    pgrep -u ${user} smplayer || return 1
    systemd-run --uid=${user} -E DISPLAY=:0 smplayer -send-action $*
}
smplayer_addplaylist() {
    local user=$1
    shift 1
    logger -t triggerhappy "smplayer add playlist $*"
    pgrep -u ${user} smplayer || return 1
    systemd-run --uid=${user} -E DISPLAY=:0 smplayer -add-to-playlist $*
}
xsendkey() {
    # wmctrl -l
    local user=$1
    shift 1
    logger -t triggerhappy "triggerhappy xsendkey [$*]"
    systemd-run --scope --uid=${user} -E DISPLAY=:0 xdotool search --desktop 0 "${LIST_FILE}" windowactivate key --clearmodifiers $*
}
case "$2" in
    start_stop)      smplayer_start_stop ${1};;
    smplayer)        smplayer_action ${1} ${3};;
    xsendkey)        xsendkey ${1} ${3};;
    *)  logger -t triggerhappy "Unexpected option: $1";;
esac
EOF
chmod 755 /usr/bin/remoter.sh
