server {
    listen 9999;
    server_name _;
    location @401 {
        return 200 '<html><head>login</head><body>
<form method="get" action="/" authenticate="Basic">
<label for="username">Username:</label> <input type="text" id="username" authenticate="username">
<label for="password">Password:</label> <input type="text" id="password" authenticate="password">
<input type="submit" value="Log In">
</form></body></html>';
    }
    location / {
        auth_request /auth;
        proxy_intercept_errors on;
        error_page 401 = @401;
        root /var/www/html;
        try_files $uri $uri/ =404;
    }
    location = /auth {
        # Using Apache as the authentication proxy
        # # curl -u user1:password http://192.168.168.111/auth/ -vvv
        proxy_pass http://192.168.168.111/auth/;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }
}
# apt -y install apache2
# # Enable the Apache2 LDAP authentication module, run below
# a2enmod authnz_ldap
cat <<'EOF' > /etc/apache2/sites-enabled/ldap_auth.conf
LDAPSharedCacheSize 500000
LDAPCacheEntries 1024
LDAPCacheTTL 600
LDAPOpCacheEntries 1024
LDAPOpCacheTTL 600
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    <Directory "/var/www/html/auth">
        Options Indexes FollowSymlinks
        AuthType Basic
        AuthName "web authentication"
        AuthBasicAuthoritative Off
        AuthBasicProvider ldap
        AuthLDAPURL "ldap://10.0.2.254/ou=people,dc=xikang,dc=com?uid?sub?(objectClass=*)"
        AuthLDAPBindDN "cn=xkadmin,ou=people,dc=xikang,dc=com"
        AuthLDAPBindPassword 1997
        # Require ldap-filter objectClass=posixAccount
        Require valid-user
    </Directory>
</VirtualHost>
EOF
