#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import database as db
from sqlalchemy import func,text,Column,String,Integer,DateTime,Enum,ForeignKey
# create tables if not exists
db.Base.metadata.drop_all(db.engine)
db.Base.metadata.create_all(db.engine)

print('''
# # kvmhost
| name   | tpl       | url                                        | arch   |
|--------+-----------+--------------------------------------------+--------|
| host01 | newvm.tpl | qemu+tls://192.168.168.1/system            | x86_64 |
| asus   | newvm.tpl | qemu+ssh://root@192.168.168.1:60022/system | x86_64 |
# # kvmdevice
| kvmhost | name       | devtype | tpl        | action            |
|---------+------------+---------+------------+-------------------|
| host01  | local-disk | disk    | disk.file  | host01-disk.file  |
| host01  | rbd-disk   | disk    | disk.rbd.1 | host01-disk.rbd.1 |
| host01  | net-br-ext | net     | net.br-ext | host01-net.br-ext |
|---------+------------+---------+------------+-------------------|
| asus    | local-disk | disk    | disk.file  | asus-disk.file    |
| asus    | net-br-ext | net     | net.br-ext | asus-net.br-ext   |
# # kvmgold
| name     | arch    | tpl                  | desc |
| debian12 | x86_64  | bookworm.amd64.qcow2 |      |
| debian12 | aarch64 | bookworm.arm64.qcow2 |      |
''')
hosts=[
    db.KVMHost(name='host01',tpl='newvm.tpl',url='qemu+tls://192.168.168.1/system',arch='x86_64'),
    db.KVMHost(name='asus',tpl='newvm.tpl',url='qemu+ssh://root@192.168.168.1:60022/system',arch='x86_64'),
]
db.session.add_all(hosts)  # db.session.add(host01)
db.session.commit()

host01_devs=[
    db.KVMDevice(kvmhost='host01',name='local-disk',devtype='disk',tpl='disk.file',action='host01-disk.file'),
    db.KVMDevice(kvmhost='host01',name='rbd-disk',devtype='disk',tpl='disk.rbd.1',action='host01-disk.rbd.1'),
    db.KVMDevice(kvmhost='host01',name='net-br-ext',devtype='net',tpl='net.br-ext',action='host01-net.br-ext'),
]
db.session.add_all(host01_devs)
asus_devs=[
    db.KVMDevice(kvmhost='asus',name='local-disk',devtype='disk',tpl='disk.file',action='asus-disk.file'),
    db.KVMDevice(kvmhost='asus',name='net-br-ext',devtype='net',tpl='net.br-ext',action='asus-net.br-ext'),
]
db.session.add_all(asus_devs)
db.session.commit()

golds=[
    db.KVMGold(name='debian12',arch='x86_64', tpl='bookworm.amd64.qcow2',desc='测试主机'),
    db.KVMGold(name='debian12',arch='aarch64',tpl='bookworm.arm64.qcow2'),
]
db.session.add_all(golds)
db.session.commit()

for r in db.KVMGold.ListGold():
    print(f'{r._asdict()}')

r = db.KVMGold.getGoldInfo('debian12', 'x86_64')
print(f'{r}')

# sql="insert into tbl (name) values ('{name}')"
# dev={'name':'net'}
# db.Base.exesql(sql, **dev)

sql="select * from kvmhost"
results = db.Base.exesql(sql)
for r in results:
    print(f'{r._asdict()}')
print('===================================')
sql="select * from kvmdevice"
results = db.Base.exesql(sql)
for r in results:
    print(f'{r._asdict()}')
# results = db.Base.exesql('SELECT * FROM kvmhost join kvmdevice on kvmdevice.kvmhost = kvmhost.name')
# for r in results:
#     print(f'{r._asdict()}')
