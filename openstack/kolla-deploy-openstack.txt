kolla一键部署openstack
Kolla的目标：
（1）利用Docker产生生产级别的镜像加速OpenStack部署。
（2）简化OpenStack部署和运维操作。就是要做到100个节点开箱即用，所有的组件的HA都具备。简单说，Fuel装完是什么，他就是什么样子。实现的代价肯定比Fuel小很多。
准备工作：
1 - 最小化安装centos,关闭防火墙和selinux，并安装epel源：
#关闭防火墙和selinux
[root@all-in-one ~]# setenforce 0
[root@all-in-one ~]# getenforce 
Permissive
[root@all-in-one ~]# systemctl stop firewalld 
[root@all-in-one ~]# systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
[root@all-in-one ~]# systemctl status firewalld |grep active
   Active: inactive (dead)
#安装epel源
[root@all-in-one ~]# yum install epel-release -y
#更改IP
[root@all-in-one ~]# nmcli connection modify ens33 ipv4.method manual ipv4.addresses 10.0.0.20/24 ipv4.gateway 10.0.0.2 ipv4.dns 10.0.0.2 autoconnect yes
[root@all-in-one ~]# nmcli connection up ens33
2 - 设置主机名及/etc/hosts文件做地址解析
[root@all-in-one ~]# cat /etc/hostname
all-in-one
[root@all-in-one ~]# cat /etc/hosts
127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1 localhost localhost.localdomain localhost6 localhost6.localdomain6
10.0.0.20 all-in-one
3 - 同步时间
[root@all-in-one ~]# yum install chrony -y
[root@all-in-one ~]# systemctl enable chronyd
[root@all-in-one ~]# systemctl start chronyd
[root@all-in-one ~]# chronyc sources
210 Number of sources = 4
MS Name/IP address         Stratum Poll Reach LastRx Last sample               
===============================================================================
^* 0.centos.pool.ntp.org         2   6    17    20   -980us[-2039us] +/-   28ms
^? makaki.miuku.net              0   7     0     -     +0ns[   +0ns] +/-    0ns
^- de-user.deepinid.deepin.>     3   6   115    13    -30ms[  -30ms] +/-  145ms
^+ h199-182-204-197.ip4.unm>     2   6    17    20   +985us[  -73us] +/-   93ms
4 - 双网卡
ens33 10.0.0.20 负责openstack管理网络，这个网络要能上网，以便以后可以安装包
ens37 负责openstack外部网络，最好不配置ip地址，如果配置了，安装完后也就不能用了
#看一下网卡
[root@all-in-one ~]# nmcli connection show 
NAME   UUID                                  TYPE      DEVICE 
ens33  6fb9133f-b8ac-4cfd-9180-650c1ee33c85  ethernet  ens33  
ens37  3f220bb8-593b-338c-aa8a-271b6358fd2d  ethernet  ens37  
5 - 安装docker
[root@all-in-one ~]# yum install  python-devel libffi-devel gcc openssl-devel git python-pip -y
#
[root@all-in-one ~]# yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-selinux docker-engine-selinux docker-engine 
#
[root@all-in-one ~]#  sudo yum install  -y yum-utils device-mapper-persistent-data lvm2
6 - 装官方源
[root@all-in-one ~]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
​mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
7 - 安装
[root@all-in-one ~]# yum install docker-ce docker-ce-cli containerd.io -y
8 - 开启服务
[root@all-in-one ~]# systemctl enable docker.service
Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.
[root@all-in-one ~]# systemctl start docker.service 
[root@all-in-one ~]# systemctl status docker.service  | grep active
   Active: active (running) since 六 2020-05-23 10:53:57 CST; 8s ago
9 - 测试
[root@all-in-one ~]# docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
0e03bdcc26d7: Pull complete 
Digest: sha256:6a65f928fb91fcfbc963f7aa6d57c8eeb426ad9a20c7ee045538ef34847f44f1
Status: Downloaded newer image for hello-world:latest
Hello from Docker!
This message shows that your installation appears to be working correctly.
To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.
To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash
Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/
For more examples and ideas, visit:
 https://docs.docker.com/get-started/
10 - 下载加速器
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://7bc3o1s2.mirror.aliyuncs.com"]
}
EOF
[root@all-in-one docker]# sudo systemctl daemon-reload
[root@all-in-one docker]# sudo systemctl restart docker
查看已经有了加速器
[root@all-in-one docker]# docker info
Registry Mirrors:
  https://qvfrdgm3.mirror.aliyuncs.com/
11 - 确认PIP环境,升级PIP
[root@all-in-one docker]# pip install  -U pip  Successfully installed pip-20.1.1
12 - 安装Kolla-ansible
#可以从GITHUB上克隆 ：
[root@all-in-one ~]# git clone  https://github.com/openstack/kolla-ansible  -b stable/train
正克隆到 'kolla-ansible'...
remote: Enumerating objects: 109, done.
remote: Counting objects: 100% (109/109), done.
remote: Compressing objects: 100% (85/85), done.
remote: Total 107039 (delta 41), reused 64 (delta 21), pack-reused 106930
接收对象中: 100% (107039/107039), 19.87 MiB | 16.00 KiB/s, done.
处理 delta 中: 100% (70052/70052), done.
13 - 安装
[root@all-in-one ~]#  yum install  ansible  -y
[root@all-in-one ~]#  cd  kolla-ansible/
[root@all-in-one kolla-ansible]# sudo pip install  kolla-ansible --ignore-installed PyYAML
    Running setup.py install for backports.ssl-match-hostname ... done
    Running setup.py install for wrapt ... done
    Running setup.py install for PyYAML ... done
    Running setup.py install for kolla-ansible ... done
Successfully installed Babel-2.8.0 Jinja2-2.11.2 MarkupSafe-1.1.1 PyYAML-5.3.1 backports.ssl-match-hostname-3.7.0.1 certifi-2020.4.5.1 cffi-1.14.0 chardet-3.0.4 cryptography-2.9.2 debtcollector-1.22.0 docker-4.2.0 enum34-1.1.10 funcsigs-1.0.2 idna-2.9 ipaddress-1.0.23 iso8601-0.1.12 jmespath-0.10.0 kolla-ansible-9.1.0 monotonic-1.5 netaddr-0.7.19 netifaces-0.10.9 oslo.config-7.0.0 oslo.i18n-3.25.1 oslo.utils-3.42.1 pbr-5.4.5 pycparser-2.20 pyparsing-2.4.7 pytz-2020.1 requests-2.23.0 rfc3986-1.4.0 setuptools-44.1.0 six-1.15.0 stevedore-1.32.0 urllib3-1.25.9 websocket-client-0.57.0 wrapt-1.12.1
14 - 安装好后做环境配置
[root@all-in-one ~]# mkdir  /etc/kolla 
[root@all-in-one ~]# chown   root:root  /etc/kolla/
[root@all-in-one ~]# cp  -r  kolla-ansible/etc/kolla/*  /etc/kolla/
[root@all-in-one ~]# cp  kolla-ansible/ansible/inventory/* /home/
[root@all-in-one ~]# mkdir  /etc/kolla/config/nova -p
[root@all-in-one ~]# cd 
[root@all-in-one ~]# vim /etc/kolla/config/nova/nova-compute.conf
[root@all-in-one ~]# cat /etc/kolla/config/nova/nova-compute.conf
[libvirt]
virt_type=qemu
cpu_mode = none
[root@all-in-one ~]# vim /etc/ansible/ansible.cfg 
[defaults]
host_key_checking=False
pipelining=True
forks=100
[root@all-in-one ~]# kolla-genpwd
[root@all-in-one ~]# vim  /etc/kolla/passwords.yml
keystone_admin_password: Com.123  #不能全是数字哟（admin和dashboard的密码）
15 - 配置kolla-ansible
[root@all-in-one ~]# vim /etc/kolla/globals.yml
kolla_base_distro: "centos"
kolla_install_type: "source"
openstack_release: "train"
network_interface: "ens33"
neutron_external_interface: "ens37"
kolla_internal_vip_address: "10.0.0.250"
16 - 具有kolla的Bootstrap服务器部署依赖项：
[root@all-in-one ~]# kolla-ansible -i /home/all-in-one bootstrap-servers
17 - 对主机进行部署前检查：
[root@all-in-one ~]# kolla-ansible -i /home/all-in-one deploy
[root@all-in-one ~]# docker images
REPOSITORY                                  TAG                 IMAGE ID            CREATED             SIZE
kolla/centos-source-nova-compute            train               0bdab2688eeb        22 hours ago        1.88GB
kolla/centos-source-glance-api              train               135f7042305f        22 hours ago        948MB
kolla/centos-source-placement-api           train               139a50420850        22 hours ago        919MB
kolla/centos-source-keystone-fernet         train               c50864dfceb8        22 hours ago        918MB
kolla/centos-source-keystone-ssh            train               269c4112c01e        22 hours ago        919MB
kolla/centos-source-keystone                train               e3ad7577b29f        22 hours ago        917MB
kolla/centos-source-nova-api                train               c415c5a3f3db        22 hours ago        1.08GB
kolla/centos-source-nova-ssh                train               f01e201f9d94        22 hours ago        1.05GB
kolla/centos-source-nova-scheduler          train               b78728e692c1        22 hours ago        1.02GB
kolla/centos-source-nova-novncproxy         train               59ecb954703e        22 hours ago        1.05GB
kolla/centos-source-nova-conductor          train               23027b6e1e19        22 hours ago        1.02GB
kolla/centos-source-nova-libvirt            train               1fb6d6aaff2a        22 hours ago        1.25GB
kolla/centos-source-openvswitch-vswitchd    train               fde1bc3d305b        22 hours ago        425MB
kolla/centos-source-openvswitch-db-server   train               b9417142762a        22 hours ago        425MB
kolla/centos-source-kolla-toolbox           train               866d40bbd8a0        22 hours ago        842MB
kolla/centos-source-keepalived              train               4ae3e5b0eff3        22 hours ago        414MB
kolla/centos-source-fluentd                 train               4a412a485e0c        22 hours ago        697MB
kolla/centos-source-chrony                  train               a3efe07d5c8e        22 hours ago        408MB
kolla/centos-source-mariadb                 train               948f10edbd73        22 hours ago        593MB
kolla/centos-source-memcached               train               77d638b0c015        22 hours ago        408MB
kolla/centos-source-rabbitmq                train               faa1829cf94a        22 hours ago        487MB
kolla/centos-source-haproxy                 train               25c1e39ec513        22 hours ago        433MB
kolla/centos-source-cron                    train               8463d88f41e7        23 hours ago        408MB
#失败了，加速器被偷换掉了，但是不慌
18 - 先把加速器整回来
[root@all-in-one docker]# sudo tee /etc/docker/daemon.json <<-'EOF'
> {
>   "registry-mirrors": ["https://7bc3o1s2.mirror.aliyuncs.com"]
> }
> EOF
{
  "registry-mirrors": ["https://7bc3o1s2.mirror.aliyuncs.com"]
}
[root@all-in-one docker]# systemctl daemon-reload
[root@all-in-one docker]# systemctl restart docker
[root@all-in-one docker]# cat daemon.json 
{
  "registry-mirrors": ["https://7bc3o1s2.mirror.aliyuncs.com"]
}
19 - 拉取镜像
#拉镜像 启容器
[root@all-in-one ~]# kolla-ansible -i /home/all-in-one deploy
#总报红后换了这种拉取方式：
[root@all-in-one ~]# vim docker_openstack.sh
[root@all-in-one ~]# cat docker_openstack.sh 
#!/bin/bash
docker pull kolla/centos-source-fluentd:train
docker pull kolla/centos-source-horizon:train
docker pull kolla/centos-source-heat-api:train
docker pull kolla/centos-source-heat-api-cfn:train
docker pull kolla/centos-source-heat-engine:train
docker pull kolla/centos-source-neutron-server:train
docker pull kolla/centos-source-neutron-openvswitch-agent:train
docker pull kolla/centos-source-neutron-l3-agent:train
docker pull kolla/centos-source-neutron-metadata-agent:train
docker pull kolla/centos-source-neutron-dhcp-agent:train
docker pull kolla/centos-source-nova-api:train
docker pull kolla/centos-source-nova-ssh:train
docker pull kolla/centos-source-nova-scheduler:train
docker pull kolla/centos-source-nova-conductor:train
docker pull kolla/centos-source-nova-novncproxy:train
docker pull kolla/centos-source-nova-compute:train
docker pull kolla/centos-source-nova-libvirt:train
docker pull kolla/centos-source-glance-api:train
docker pull kolla/centos-source-placement-api:train
docker pull kolla/centos-source-keystone:train
docker pull kolla/centos-source-keystone-ssh:train
docker pull kolla/centos-source-keystone-fernet:train
docker pull kolla/centos-source-openvswitch-db-server:train
docker pull kolla/centos-source-openvswitch-vswitchd:train
docker pull kolla/centos-source-kolla-toolbox:train
docker pull kolla/centos-source-memcached:train
docker pull kolla/centos-source-chrony:train
docker pull kolla/centos-source-rabbitmq:train
docker pull kolla/centos-source-mariadb:train
docker pull kolla/centos-source-haproxy:train
docker pull kolla/centos-source-cron:train
docker pull kolla/centos-source-keepalived:train
[root@all-in-one ~]# . docker_openstack.sh 
#瞅一眼
[root@all-in-one ~]# docker images
REPOSITORY                                      TAG                 IMAGE ID            CREATED             SIZE
kolla/centos-source-horizon                     train               bda506186490        24 hours ago        1.03GB
kolla/centos-source-nova-compute                train               0bdab2688eeb        25 hours ago        1.88GB
kolla/centos-source-glance-api                  train               135f7042305f        25 hours ago        948MB
kolla/centos-source-placement-api               train               139a50420850        25 hours ago        919MB
kolla/centos-source-keystone-fernet             train               c50864dfceb8        25 hours ago        918MB
kolla/centos-source-keystone-ssh                train               269c4112c01e        25 hours ago        919MB
kolla/centos-source-keystone                    train               e3ad7577b29f        25 hours ago        917MB
kolla/centos-source-neutron-server              train               cf053326848c        25 hours ago        1.02GB
kolla/centos-source-neutron-l3-agent            train               f16213ac57b3        25 hours ago        1.03GB
kolla/centos-source-neutron-openvswitch-agent   train               341065ffd169        25 hours ago        997MB
kolla/centos-source-neutron-metadata-agent      train               db692452cc4e        25 hours ago        997MB
kolla/centos-source-neutron-dhcp-agent          train               7b056b895170        25 hours ago        997MB
kolla/centos-source-nova-api                    train               c415c5a3f3db        25 hours ago        1.08GB
kolla/centos-source-heat-api                    train               38a7f118449b        25 hours ago        911MB
kolla/centos-source-heat-api-cfn                train               14880f3c8280        25 hours ago        911MB
kolla/centos-source-heat-engine                 train               79629ce421fc        25 hours ago        911MB
kolla/centos-source-nova-ssh                    train               f01e201f9d94        25 hours ago        1.05GB
kolla/centos-source-nova-scheduler              train               b78728e692c1        25 hours ago        1.02GB
kolla/centos-source-nova-conductor              train               23027b6e1e19        25 hours ago        1.02GB
kolla/centos-source-nova-novncproxy             train               59ecb954703e        25 hours ago        1.05GB
kolla/centos-source-nova-libvirt                train               1fb6d6aaff2a        25 hours ago        1.25GB
kolla/centos-source-openvswitch-vswitchd        train               fde1bc3d305b        25 hours ago        425MB
kolla/centos-source-openvswitch-db-server       train               b9417142762a        25 hours ago        425MB
kolla/centos-source-kolla-toolbox               train               866d40bbd8a0        25 hours ago        842MB
kolla/centos-source-keepalived                  train               4ae3e5b0eff3        25 hours ago        414MB
kolla/centos-source-fluentd                     train               4a412a485e0c        25 hours ago        697MB
kolla/centos-source-chrony                      train               a3efe07d5c8e        25 hours ago        408MB
kolla/centos-source-mariadb                     train               948f10edbd73        25 hours ago        593MB
kolla/centos-source-memcached                   train               77d638b0c015        25 hours ago        408MB
kolla/centos-source-rabbitmq                    train               faa1829cf94a        25 hours ago        487MB
kolla/centos-source-haproxy                     train               25c1e39ec513        25 hours ago        433MB
kolla/centos-source-cron 
20 - 然后就可以安装Openstack客户端啦
pip install python-openstackclient
